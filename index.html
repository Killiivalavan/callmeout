<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>callMeOut</title>
		<link href="style.css" rel="stylesheet">
	</head>
	<body>
		<main class="glass-container">
			<h1>callMeOut</h1>
			<h2>a simple, efficient and annoying git push tracker</h2>
			<a id="github-login" href="#" class="disabled">Loading...</a>
		</main>
		<script>
			window.addEventListener('DOMContentLoaded', () => {
				const githubLogin = document.getElementById('github-login');

				// Check if user is already logged in
				fetch('/api/me', {
					credentials: 'include' // Important: Include cookies in the request
				})
					.then(response => {
						if (response.ok) {
							// User is logged in, redirect to dashboard
							window.location.href = '/dashboard';
							return null;
						}
						// User is not logged in (401 is expected), show login button
						return fetch('/config', {
							credentials: 'include'
						});
					})
					.then(response => {
						if (!response) return null; // Already redirected
						return response.json();
					})
					.then(config => {
						if (!config) return; // Already redirected
						// Use current hostname dynamically (works for localhost and production)
						const redirectUri = `${window.location.origin}/callback`;
						const authorizeUrl = `https://github.com/login/oauth/authorize?client_id=${config.client_id}&redirect_uri=${encodeURIComponent(redirectUri)}`;
						
						githubLogin.href = authorizeUrl;
						githubLogin.textContent = 'Connect to GitHub';
						githubLogin.classList.remove('disabled');
					})
					.catch(error => {
						console.error('Error fetching config:', error);
						githubLogin.textContent = 'Could not load login link.';
					});
			});
		</script>
	</body>
</html>
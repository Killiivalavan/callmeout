<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Dashboard</title>
    <link href="style.css" rel="stylesheet">
</head>
<body>
    <div class="settings-container">
        <button id="settings-btn" class="settings-button">⚙️</button>
        <div id="settings-dropdown" class="dropdown-content">
            <label for="goal-input">Daily Push Goal:</label>
            <input type="number" id="goal-input" min="1">
			<label for="annoy-time-input">Annoy after</label>
			<input type="time" id="annoy-time-input">
			<label for="discord-url">Discord Webhook URL</label>
			<input type="url" id="discord-url">
			<div id="settings-message" class="settings-message"></div>
			<button id="save-goal-btn">Save</button>
			<button id="test-webhook-btn" style="margin-top: 10px; background-color: #5865F2;">Test Discord Webhook</button>
			<hr style="border: none; border-top: 1px solid rgba(255, 255, 255, 0.1); margin: 12px 0;">
			<button id="signout-btn" class="signout-button">Sign Out</button>
        </div>
    </div>

	<h1 id="welcome-text"></h1>
    <p id="push-goal"></p>
	<div class="graph-grid"></div>

    <script>
        window.addEventListener('DOMContentLoaded', () => {
            const pushGoalElement = document.getElementById('push-goal');
			const dashboardIntroElement = document.getElementById('welcome-text')
			const graphGrid = document.querySelector('.graph-grid');
			const pushGoal = document.getElementById('goal-input');
			const annoyTime = document.getElementById('annoy-time-input');
			const discWebhook = document.getElementById('discord-url');
            fetch('/api/me')
                .then(response => {
                    if (!response.ok) {
                        // If not authenticated, redirect to the login page
                        window.location.href = '/';
                        throw new Error('Not authenticated');
                    }
                    return response.json();
                })
                .then(data => {
					pushGoalElement.textContent = `Your daily push goal is ${data.push_goal} time(s)`
					dashboardIntroElement.textContent = `Hello, ${data.github_username}!`
					pushGoal.value = data.push_goal || '';
					annoyTime.value = data.annoy_time || '';
					discWebhook.value = data.discord_webhook_url || '';
					const gitData = new Map();
					for (const record of data.github_counter) {
						gitData.set(record.date, record.push_counter);
					};
					const today = new Date();
					const squares = [];
					for (let i = 0; i<365; i++) {
						const dateString = today.toISOString().split('T')[0];
						const count = gitData.get(dateString) || 0;
						const square = document.createElement('div');
						square.classList.add('sq');
						let level = 0;
						if (count > 0 && count <=2) {
							level = 1;
						} else if (count >2 && count <=5) {
							level = 2;
						} else if (count >5 && count <= 10) {
							level = 3;
						} else if (count > 10) {
							level = 4;
						}
						square.classList.add(`level-${level}`);
						squares.push(square);
						today.setDate(today.getDate() - 1);
					}
					for (let i = squares.length - 1; i >= 0; i--) {
						graphGrid.appendChild(squares[i]);
					}
                })
                .catch(error => {
                    // This catch block will handle the "Not authenticated" error gracefully
                    console.error('Error fetching data:', error);
                });
			
            const settingsBtn = document.getElementById('settings-btn');
            const dropdown = document.getElementById('settings-dropdown');
			const saveBtn = document.getElementById('save-goal-btn');
            // Start with the dropdown hidden
            dropdown.style.display = 'none';
            settingsBtn.addEventListener('click', () => {
              if (dropdown.style.display === 'none') {
                dropdown.style.display = 'flex';
              } else {
                dropdown.style.display = 'none';
              }
            });
			saveBtn.addEventListener('click', async () => {
				const messageElement = document.getElementById('settings-message');
				const newPushGoal = pushGoal.value.trim();
				const newAnnoyTime = annoyTime.value.trim();
				const newDiscWebhook = discWebhook.value.trim();

				// Clear previous messages
				messageElement.textContent = '';
				messageElement.className = 'settings-message';

				// Disable save button during request
				saveBtn.disabled = true;
				saveBtn.textContent = 'Saving...';

				try {
					const updateData = {};
					if (newPushGoal) {
						updateData.push_goal = newPushGoal;
					}
					if (newAnnoyTime) {
						updateData.annoy_time = newAnnoyTime;
					}
					// Include discord_webhook_url even if empty (to allow clearing it)
					updateData.discord_webhook_url = newDiscWebhook;

					const response = await fetch('/api/settings', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json'
						},
						body: JSON.stringify(updateData)
					});

					// Check content type before parsing
					const contentType = response.headers.get('content-type');
					if (!contentType || !contentType.includes('application/json')) {
						const text = await response.text();
						throw new Error(`Server returned ${response.status}: ${text.substring(0, 100)}`);
					}

					const result = await response.json();

					if (!response.ok) {
						throw new Error(result.error || 'Failed to save settings');
					}

					// Show success message
					messageElement.textContent = 'Settings saved successfully!';
					messageElement.className = 'settings-message success';

					// Update the displayed push goal text
					if (result.data && result.data.push_goal) {
						pushGoalElement.textContent = `Your daily push goal is ${result.data.push_goal} time(s)`;
					}

					// Clear message after 3 seconds
					setTimeout(() => {
						messageElement.textContent = '';
						messageElement.className = 'settings-message';
					}, 3000);

				} catch (error) {
					console.error('Error saving settings:', error);
					messageElement.textContent = error.message || 'Failed to save settings. Please try again.';
					messageElement.className = 'settings-message error';
				} finally {
					saveBtn.disabled = false;
					saveBtn.textContent = 'Save';
				}
			})

			// Test webhook button
			const testWebhookBtn = document.getElementById('test-webhook-btn');
			testWebhookBtn.addEventListener('click', async () => {
				const messageElement = document.getElementById('settings-message');
				
				// Clear previous messages
				messageElement.textContent = '';
				messageElement.className = 'settings-message';

				// Disable button during request
				testWebhookBtn.disabled = true;
				testWebhookBtn.textContent = 'Testing...';

				try {
					const response = await fetch('/api/test-webhook', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json'
						}
					});

					// Check content type before parsing
					const contentType = response.headers.get('content-type');
					if (!contentType || !contentType.includes('application/json')) {
						const text = await response.text();
						throw new Error(`Server returned ${response.status}: ${text.substring(0, 100)}`);
					}

					const result = await response.json();

					if (!response.ok) {
						throw new Error(result.error || 'Failed to send test notification');
					}

					// Show success message
					messageElement.textContent = result.message || 'Test notification sent! Check your Discord channel.';
					messageElement.className = 'settings-message success';

					// Clear message after 5 seconds
					setTimeout(() => {
						messageElement.textContent = '';
						messageElement.className = 'settings-message';
					}, 5000);

				} catch (error) {
					console.error('Error testing webhook:', error);
					messageElement.textContent = error.message || 'Failed to send test notification. Please try again.';
					messageElement.className = 'settings-message error';
				} finally {
					testWebhookBtn.disabled = false;
					testWebhookBtn.textContent = 'Test Discord Webhook';
				}
			});

			// Sign out button
			const signoutBtn = document.getElementById('signout-btn');
			signoutBtn.addEventListener('click', async () => {
				try {
					const response = await fetch('/api/signout', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json'
						}
					});

					if (response.ok) {
						// Redirect to home page after sign out
						window.location.href = '/';
					} else {
						console.error('Failed to sign out');
						// Still redirect even if there's an error
						window.location.href = '/';
					}
				} catch (error) {
					console.error('Error signing out:', error);
					// Still redirect even if there's an error
					window.location.href = '/';
				}
			});

        });
    </script>
</body>
</html>
